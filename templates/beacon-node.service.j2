[Unit]
Description=Nimbus Beacon Node on {{ beacon_node_network }} network ({{ beacon_node_repo_branch }})
Documentation=https://github.com/status-im/nimbus-eth2
Requires=network-online.target
After=network-online.target

[Service]
User={{ beacon_node_user }}
Group={{ beacon_node_group }}
LimitNOFILE={{ beacon_node_service_nofile_limit }}
WorkingDirectory={{ beacon_node_service_path }}
SyslogIdentifier={{ beacon_node_service_name }}
SyslogFacility=local6
SyslogLevel=debug
Restart=on-failure
RestartPreventExitStatus={{ beacon_node_doppelganger_exit_code }}
ExecStart={{ beacon_node_repo_path }}/build/nimbus_beacon_node \
    --network={{ beacon_node_network }} \
    --data-dir={{ beacon_node_data_path }} \
    --secrets-dir={{ beacon_node_secrets_path }} \
    --validators-dir={{ beacon_node_validators_path }} \
    --era-dir={{ beacon_node_era_dir_path }} \
{% for url in beacon_node_web3_urls | mandatory %}
    --web3-url={{ url | mandatory }} \
{% endfor %}
{% if beacon_node_web3_jwt_secret is defined %}
    --jwt-secret={{ beacon_node_web3_jwt_secret_path | mandatory }} \
{% endif %}
{% if beacon_node_suggested_fee_recipient is defined %}
    --suggested-fee-recipient={{ beacon_node_suggested_fee_recipient | mandatory }} \
{% endif %}
{% if beacon_node_payload_builder_enabled %}
    --payload-builder={{ beacon_node_payload_builder_enabled | to_json }} \
    --payload-builder-url={{ beacon_node_payload_builder_url | mandatory }} \
{% endif %}
    --log-format={{ beacon_node_log_format }} \
    --log-level={{ beacon_node_log_level }} \
    --nat=extip:{{ beacon_node_public_address }} \
    --tcp-port={{ beacon_node_listening_port }} \
    --udp-port={{ beacon_node_discovery_port }} \
    --max-peers={{ beacon_node_max_peers }} \
    --netkey-file={{ beacon_node_netkey_path }} \
    --slashing-db-kind={{ beacon_node_slashing_db_kind }} \
    --insecure-netkey-password=true \
    --subscribe-all-subnets={{ beacon_node_subscribe_all | to_json }} \
    --doppelganger-detection={{ beacon_node_doppelganger_detection | to_json }} \
    --num-threads={{ beacon_node_threads }} \
    --rpc={{ beacon_node_rpc_enabled | to_json }} \
{% if beacon_node_rpc_enabled %}
    --rpc-address={{ beacon_node_rpc_address }} \
    --rpc-port={{ beacon_node_rpc_port }} \
{% endif %}
    --rest={{ beacon_node_rest_enabled | to_json }} \
{% if beacon_node_rest_enabled %}
    --rest-address={{ beacon_node_rest_address }} \
    --rest-port={{ beacon_node_rest_port }} \
    --rest-max-body-size={{ beacon_node_rest_max_body_size | mandatory }} \
    --rest-max-headers-size={{ beacon_node_rest_max_headers_size | mandatory }} \
{% endif %}
    --metrics={{ beacon_node_metrics_enabled | to_json }} \
{% if beacon_node_metrics_enabled %}
    --metrics-address={{ beacon_node_metrics_address }} \
    --metrics-port={{ beacon_node_metrics_port }} \
{% endif %}
{% if beacon_node_validator_monitor_auto %}
    --validator-monitor-auto \
{% endif %}
{% if beacon_node_validator_monitor_totals %}
    --validator-monitor-totals \
{% endif %}
{% for pubkey in beacon_node_validator_monitor_pubkeys %}
    --validator-monitor-pubkey={{ pubkey }} \
{% endfor %}
{% if beacon_node_light_client_data_enabled %}
    --light-client-data-serve={{ beacon_node_light_client_data_serve | to_json }} \
    --light-client-data-import-mode={{ beacon_node_light_client_data_import_mode }} \
{% if beacon_node_light_client_data_max_periods >= 0 %}
    --light-client-data-max-periods={{ beacon_node_light_client_data_max_periods }} \
{% endif %}
{% endif %}
{% for extra_flag in beacon_node_extra_flags %}
    {{ extra_flag }}
{% endfor %}

[Install]
WantedBy=multi-user.target
